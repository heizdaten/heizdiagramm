<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Fernwärme – Temperaturverlauf Meßintervall 15 Min</title>

<script src="chart1.js"></script>
//<script src="chartjs-plugin-zoom.min.js"></script>

</head>

<body>

<h2>Fernwärme – Temperaturverlauf °C  Meßintervall: 15 Min</h2> <h2><label for="anzahl">Angezeigte Tage:</label>
<select id="anzahl">
  <option value="96"selected> 1 Tag</option>
  <option value="192"> 2 Tage</option>
  <option value="384"> 4 Tage</option>
  <option value="672" > 7 Tage)</option>
</select><h2>


</p>

<canvas id="chart"></canvas>

<script>
let allData = [];
let chart;

fetch("https://script.google.com/macros/s/AKfycbzCfO_a0-IU6QIj3i2yF6ZwdwOxwToCLkT0aQHKXhLyNdRcarK73ov1Pj0fDHYJYzG1aA/exec")
.then(r => r.text())
.then(text => {

  allData = text.trim().split("\n").slice(1);
  const startWert = parseInt(document.getElementById("anzahl").value);
  drawChart(startWert);
});
 
document.getElementById("anzahl").addEventListener("change", e => {
  drawChart(parseInt(e.target.value));
});

function drawChart(count) {

  const data = allData.slice(-count);

  let labels = [], t1 = [], t2 = [], t3 = [], t4 = [];

  data.forEach(l => {
    const c = l.split(",");
const [date, time] = c[0].split(" ");
labels.push({ date, time });

    t1.push(+c[1]);
    t2.push(+c[2]);
    t3.push(+c[3]);
    t4.push(+c[4]);
  });

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Vorlauf", data: t1, borderColor: "green", fill: false },
        { label: "Rücklauf", data: t4, borderColor: "yellow", fill: false },
        { label: "Außen", data: t2, borderColor: "blue", fill: false },
        { label: "Raum", data: t3, borderColor: "orange", fill: false }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        zoom: {
          pan: { enabled: true, mode: "x" },
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: "x"
          }
        }
      }
        
   scales: {
  x: {
    ticks: {
      callback: function(value, index) {
        const current = labels[index];
        const prev = labels[index - 1];

        // erstes Label → Datum anzeigen
        if (!prev || current.date !== prev.date) {
          const d = current.date.split("-");
          return `${d[2]}.${d[1]}.${d[0]}\n${current.time}`;
        }

        // sonst nur Zeit
        return current.time;
      },
      maxRotation: 0,
      autoSkip: true,
      maxTicksLimit: 12
    }
  },
  y: {
    title: {
      display: true,
      text: "Temperatur °C"
    }
  }
}

  });
}
</script>
<p>
<a href="https://script.google.com/macros/s/AKfycbzCfO_a0-IU6QIj3i2yF6ZwdwOxwToCLkT0aQHKXhLyNdRcarK73ov1Pj0fDHYJYzG1aA/exec" download>
⬇ CSV herunterladen
</a>

</body>
</html>
