<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Heizung – Temperaturverlauf3</title>

<!-- lokale Libraries -->
<script src="chart.js"></script>
<script src="chartjs-plugin-zoom.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}
select {
  font-size: 1em;
  margin-bottom: 10px;
}
canvas {
  max-width: 100%;
}
</style>
</head>

<body>

<h2>Heizung – Temperaturverlauf</h2>

<label for="anzahl">Angezeigte Werte:</label>
<select id="anzahl">
  <option value="96" selected>96 (1 Tag)</option>
  <option value="192">192 (2 Tage)</option>
  <option value="336">336 (3,5 Tage)</option>
  <option value="672">672 (7 Tage)</option>
</select>

<p>
<a href="https://script.google.com/macros/s/AKfycbzCfO_a0-IU6QIj3i2yF6ZwdwOxwToCLkT0aQHKXhLyNdRcarK73ov1Pj0fDHYJYzG1aA/exec" download>
⬇ CSV herunterladen
</a>
</p>

<canvas id="chart"></canvas>

<script>
let allData = [];
let chart;

// CSV laden
fetch("https://script.google.com/macros/s/AKfycbzCfO_a0-IU6QIj3i2yF6ZwdwOxwToCLkT0aQHKXhLyNdRcarK73ov1Pj0fDHYJYzG1aA/exec")
.then(r => r.text())
.then(text => {
  allData = text.trim().split("\n").slice(1);

  // Startwert aus Dropdown lesen (z. B. 96)
  const startWert = parseInt(document.getElementById("anzahl").value);
  drawChart(startWert);
});

// Dropdown-Änderung
document.getElementById("anzahl").addEventListener("change", e => {
  drawChart(parseInt(e.target.value));
});

function drawChart(count) {

  const data = allData.slice(-count);

  let labels = [], t1 = [], t2 = [], t3 = [], t4 = [];

  data.forEach(l => {
    const c = l.split(",");
    const [date, time] = c[0].split(" ");

    labels.push({ date, time });
    t1.push(+c[1]);
    t2.push(+c[2]);
    t3.push(+c[3]);
    t4.push(+c[4]);
  });

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Vorlauf",
          data: t1,
          borderColor: "red",
          borderWidth: 2,
          fill: false,
          yAxisID: "y"
        },
        {
          label: "Rücklauf",
          data: t2,
          borderColor: "blue",
          borderWidth: 2,
          fill: false,
          yAxisID: "y"
        },
        {
          label: "Außen",
          data: t3,
          borderColor: "green",
          borderWidth: 2,
          fill: false,
          yAxisID: "y"
        },
        {
          label: "Speicher",
          data: t4,
          borderColor: "orange",
          borderWidth: 2,
          fill: false,
          yAxisID: "y"
        }
      ]
    },
    options: {
      responsive: true,
      interaction: {
        mode: "index",
        intersect: false
      },
      plugins: {
        zoom: {
          pan: {
            enabled: true,
            mode: "x"
          },
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: "x"
          }
        }
      },
      scales: {
        x: {
          ticks: {
callback: function(value, index) {

    // Set für bereits angezeigte Datumswerte
    if (!this._shownDates) this._shownDates = new Set();

    const lbl = labels[index];
    const date = lbl.date;
    const time = lbl.time;

    // Datum noch nicht angezeigt → jetzt anzeigen
    if (!this._shownDates.has(date)) {
      this._shownDates.add(date);
      const d = date.split("-");
      return `${d[2]}.${d[1]}.${d[0]}\n${time}`;
    }

    // sonst nur Uhrzeit
    return time;
  },
  autoSkip: true,
  maxTicksLimit: 12
          }
        },
        y: {
          position: "left",
          title: {
            display: true,
            text: "Temperatur °C"
          }
        },
        y1: {
          position: "right",
          title: {
            display: true,
            text: "Temperatur °C"
          },
          grid: {
            drawOnChartArea: false
          }
        }
      }
    }
  });
}
</script>

</body>
</html>
